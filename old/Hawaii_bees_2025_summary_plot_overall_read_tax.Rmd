---
title: "Hawaii_bees_2025"
author: "Laura"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Project

Here I am exploring the data from Oxford Nanopore seq data from pooled bee samples collected from Hawaii in 2024/2025, we are looking at the viral lanscape, particularly DWV in Hawaii 15 years after our first study.

There are 3 islands with different conditions: Oahu - treatment free, Big Island - treat for Varroa, and Kauai - no Varroa.

RNA was extracted in Declan's lab with Clarissa and run across 4 libraries on the GridION

These are the read count data from mapping to a custom db with minimap2 in epitome labs. 

plotting histograms of overall read breakdown per sample - number of reads and overview of whether they were bee, varroa, bacteria, viruses or unclassified - from Epi2me data 


### install packages

```{r}
#install.packages("ggforce")
library(ggplot2)
library(tidyr)
library(dplyr)
library(tibble)
library(patchwork)  # For combining plots
library(forcats) # for fct_relevel
library(ggforce)  # For scaled pie charts
library(ggpubr)

```

### Load and clean the data


```{r}

dat <- read.csv("2024_Viral_Samples_Hawaii_alias.csv")

dat <- dat[c("island", "location2", "barcode", "alias", "code")]
dat <- dat %>% drop_na(barcode)


lib1 <- read.table(file = 'abundance_table_species_LIB1.tsv', sep = '\t', header = TRUE)
lib1 <- lib1 %>% select(-total) # this isn't important, total reads per species across the library

lib2 <- read.table(file = 'abundance_table_species_LIB2.tsv', sep = '\t', header = TRUE)
lib2 <- lib2 %>% select(-total)

lib3 <- read.table(file = 'abundance_table_species_LIB3.tsv', sep = '\t', header = TRUE)
lib3 <- lib3 %>% select(-total)

lib4 <- read.table(file = 'abundance_table_species_LIB4.tsv', sep = '\t', header = TRUE)
lib4 <- lib4 %>% select(-total)

lib0 <- read.table(file = 'abundance_table_species_LIB0.tsv', sep = '\t', header = TRUE)
lib0 <- lib0 %>% select(-total)

df_combined <- lib1 %>%
  full_join(lib2, by = "tax") %>%
  full_join(lib3, by = "tax") %>%
  full_join(lib4, by = "tax") %>%
  full_join(lib0, by = "tax")

# Replace NA with 0 for counts
df_combined[is.na(df_combined)] <- 0


```


## plot read depths - original

prepare data

```{r}

df_combined2 <- df_combined # just so i can keep a copy of the original

# Compute total reads per sample (excluding the "Sequence" column)
total_reads <- colSums(df_combined2[,-1])  # Exclude first column (sequences)

# Convert total_reads into a data frame and append to df_combined
total_row <- c("Total", total_reads)
df_combined2 <- rbind(df_combined2, total_row)

# Extract the total row (excluding the "Sequence" column)
total_df <- df_combined2 %>%
  filter(tax == "Total") %>%
  select(-tax) %>%
  t() %>%
  as.data.frame()

# Convert row names to a column and rename columns
total_df <- total_df %>%
  tibble::rownames_to_column(var = "alias") %>%
  rename(Total_Reads = V1) %>%
  mutate(Total_Reads = as.numeric(Total_Reads))  # Ensure numeric values


# Standardize sample names in dat (replace dashes with dots)
dat$alias <- gsub("-", "\\.", dat$alias)  

# Merge with the metadata dataframe (dat)
merged_df <- left_join(dat, total_df, by = c("alias" = "alias"))

# Check if there are any unmatched samples
#unmatched_samples <- setdiff(total_df$Sample, island_df$sample)
#print(unmatched_samples)  # Print samples that didn't match


# remove rows containing NAs 

merged_df <- merged_df %>% drop_na(Total_Reads)

merged_df <- merged_df %>%
  filter(island != "Jamaica")

```

make plot - original way

```{r}
custom_colors <- c("oahu" = "#095256", "big island" = "#087F8C", "Kauai" = "#5AAA95")#, "Jamaica" = "#FFC000")
#"oahu" = "#E69F00", "big island" = "#56B4E9", "Kauai" = "#009E73")

plot1 <- merged_df %>% 
  mutate(
    island = fct_relevel(island, "oahu", "big island", "Kauai")#,
#    alias = fct_reorder(alias, Total_Reads)
  ) %>% 
  ggplot(aes(x = alias, y = Total_Reads, fill = island)) +
  geom_col(alpha = 0.8, width = 0.85) +
  scale_fill_manual(values = custom_colors) +
#  scale_y_continuous(expand = c(0, 0.1)) +
  coord_flip() +
  facet_grid(rows = vars(island), scales = "free_y", switch = "y", space = "free_y") +
  labs(
    title = "Total Reads per Sample by Island",
    subtitle = "All Hawaii data",
   # caption = "Source: World Health Organization\nGlobal Health Observatory Data Repository",
    y = "Total reads"
  ) +
    theme(
    plot.margin = margin(0.5, 0.5, 0.5, 0.5, unit = "cm"),
    plot.title = element_text(size = 15, face = "bold"),
    strip.text.y = element_text(angle = 270, face = "bold"),
    strip.placement = "outside",
    axis.title.x = element_text(margin = margin(t = 0.5, b = 0.5, unit = "cm")),
    axis.title.y = element_blank(),
    axis.text = element_text(size = 5),
    legend.position = "none",
    panel.grid.major.y = element_blank(),
    )

plot1

# Save as PDF
#ggsave("total_reads_plot_Hawaii_all5runs.pdf", plot = plot1, width = 11, height = 8)



```



## new plot, looking at total and breakdown of reads

extract virus read data

```{r}

# prepare the dataframe for filtering 
# Split the 'tax' column into multiple taxonomic levels
df_viruses <- df_combined %>%
  separate(tax, into = c("Kingdom", "Phylum", "Class", "Order", "Family", "Subfamily", "Genus", "Species"), sep = ";", fill = "right")


df_viruses <- df_viruses %>%
  filter(Kingdom == "Viruses") 

# now remove the phages, not useful for this - actually keep them in for this plot

#df_viruses <- df_viruses %>%
#  filter(Species != "Muvirus mu")

#df_viruses <- df_viruses %>%
#  filter(Species != "Muvirus SfMu")

# subset cols to keep only species
df_viruses <- df_viruses[,-1:-7]

#convert to numeric, currently set to character variables
df_viruses <- df_viruses %>%
  mutate(across(-c(Species), as.numeric))
# already numeric, don't need this

```


calculate total viral reads, in the same way as total reads earlier then add totals to merged_df


```{r}

# Compute total reads per sample (excluding the "Species" column)
total_viral_reads <- colSums(df_viruses[, -1])

# Convert total_reads into a data frame and append to df_viruses
total_virus_row <- c("Total", total_viral_reads)
df_viruses <- rbind(df_viruses, total_virus_row)

# Extract the total virus row (excluding the "Species" column)
total_virus_df <- df_viruses %>%
  filter(Species == "Total") %>%
  select(-Species) %>%
  t() %>%
  as.data.frame()

# Convert row names to a column and rename columns
total_virus_df <- total_virus_df %>%
  tibble::rownames_to_column(var = "alias") %>%
  rename(Total_Virus_Reads = V1) %>%
  mutate(Total_Virus_Reads = as.numeric(Total_Virus_Reads))  # Ensure numeric values


# Merge with the metadata dataframe (dat)
merged_df <- left_join(merged_df, total_virus_df, by = c("alias" = "alias"))




```

now I have a merged_df containing metadata, as well as total reads and total vrius read in each sample, now add the host reads


```{r}
# Bee reads

bee_reads <- df_combined2 %>%
  filter(tax == "Eukaryota;Metazoa;Arthropoda;Insecta;Hymenoptera;Apidae;Apis;Apis mellifera") %>%
  select(-tax) %>%
  t() %>%
  as.data.frame()


# Convert row names to a column and rename columns
bee_reads <- bee_reads %>%
  tibble::rownames_to_column(var = "alias") %>%
  rename(Bee_Reads = V1) %>%
  mutate(Bee_Reads = as.numeric(Bee_Reads))  # Ensure numeric values


# Merge with the metadata dataframe (dat)
merged_df <- left_join(merged_df, bee_reads, by = c("alias" = "alias"))


```



```{r}
# Varroa reads

varroa_reads <- df_combined2 %>%
  filter(tax == "Eukaryota;Metazoa;Arthropoda;Arachnida;Mesostigmata;Varroidae;Varroa;Varroa destructor") %>%
  select(-tax) %>%
  t() %>%
  as.data.frame()


# Convert row names to a column and rename columns
varroa_reads <- varroa_reads %>%
  tibble::rownames_to_column(var = "alias") %>%
  rename(Varroa_Reads = V1) %>%
  mutate(Varroa_Reads = as.numeric(Varroa_Reads))  # Ensure numeric values


# Merge with the metadata dataframe (dat)
merged_df <- left_join(merged_df, varroa_reads, by = c("alias" = "alias"))


```


now for total bacteria - same method as total virus


```{r}

# prepare the dataframe for filtering 
df_bact <- df_combined %>%
  separate(tax, into = c("Kingdom", "Phylum", "Class", "Order", "Family", "Subfamily", "Genus", "Species"), sep = ";", fill = "right")


df_bact <- df_bact %>%
  filter(Kingdom == "Bacteria") 

# subset cols to keep only species
df_bact <- df_bact[,-1:-7]

#convert to numeric, currently set to character variables
df_bact <- df_bact %>%
  mutate(across(-c(Species), as.numeric))
# already numeric, don't need this

# Compute total reads per sample (excluding the "Species" column)
total_bact_reads <- colSums(df_bact[, -1])

# Convert total_reads into a data frame and append to df_viruses
total_bact_row <- c("Total", total_bact_reads)
df_bact <- rbind(df_bact, total_bact_row)

# Extract the total virus row (excluding the "Species" column)
total_bact_df <- df_bact %>%
  filter(Species == "Total") %>%
  select(-Species) %>%
  t() %>%
  as.data.frame()

# Convert row names to a column and rename columns
total_bact_df <- total_bact_df %>%
  tibble::rownames_to_column(var = "alias") %>%
  rename(Total_Bacteria_Reads = V1) %>%
  mutate(Total_Bacteria_Reads = as.numeric(Total_Bacteria_Reads))  # Ensure numeric values


# Merge with the metadata dataframe (dat)
merged_df <- left_join(merged_df, total_bact_df, by = c("alias" = "alias"))


```


now for fungi - nah, there's nothing really to report here


```{r}

# prepare the dataframe for filtering 
#df_fung <- df_combined %>%
#  separate(tax, into = c("Kingdom", "Phylum", "Class", "Order", "Family", "Subfamily", "Genus", "Species"), sep = ";", fill = "right")


#df_fung <- df_fung %>%
#  filter(Phylum == "Fungi") 

# subset cols to keep only species
#df_fung <- df_fung[,-1:-7]

#convert to numeric, currently set to character variables
#df_fung <- df_fung %>%
#  mutate(across(-c(Species), as.numeric))
# already numeric, don't need this

# Compute total reads per sample (excluding the "Species" column)
#total_fung_reads <- colSums(df_fung[, -1])

# Convert total_reads into a data frame and append to df_viruses
#total_fung_row <- c("Total", total_fung_reads)
#df_bact <- rbind(df_bact, total_fung_row)

# Extract the total virus row (excluding the "Species" column)
#total_fung_df <- df_fung %>%
#  filter(Species == "Total") %>%
#  select(-Species) %>%
#  t() %>%
#  as.data.frame()

# Convert row names to a column and rename columns
#total_fung_df <- total_fung_df %>%
#  tibble::rownames_to_column(var = "alias") %>%
#  rename(Total_Fungi_Reads = V1) %>%
#  mutate(Total_Fungi_Reads = as.numeric(Total_Fungi_Reads))  # Ensure numeric values


# Merge with the metadata dataframe (dat)
#merged_df <- left_join(merged_df, total_fung_df, by = c("alias" = "alias"))

# there's hardly any of these, nothing that will show up on a graph, remove this


```

now prepare to plot, the df needs reformatting

```{r}


# Add a new column 'other_reads'
merged_df <- merged_df %>%
  mutate(Unclassified_other_reads = Total_Reads - (Total_Bacteria_Reads + Total_Virus_Reads + Bee_Reads + Varroa_Reads))



# Convert wide format to long format
long_df <- merged_df %>%
  pivot_longer(cols = c(Unclassified_other_reads, Total_Bacteria_Reads, Total_Virus_Reads, Bee_Reads, Varroa_Reads),  # Specify count columns to pivot
               names_to = "read_category",   # New column for the variable names
               values_to = "count")      # New column for the values

# View the transformed data
head(long_df)

long_df <- long_df %>%
  mutate(read_category = factor(read_category, levels = rev(c("Bee_Reads", 
                                                              "Varroa_Reads", 
                                                              "Total_Bacteria_Reads", 
                                                              "Total_Virus_Reads", 
                                                              "Unclassified_other_reads")))) # so the order of the bars in the stack is as I want it, it needs to be in reverse to plot with bees at the bottom


```




set colours

```{r}
# for now I just want to colour the known bee viruses, the odd read of other things isn't what I'm interested in now.

custom_colours2 <- c(
#  "Iflavirus aladeformis" = "#d62828",
  "Total_Bacteria_Reads" = "#064789",
  "Bee_Reads" = "#EDAE49",
  "Total_Virus_Reads" = "#ECA0FF",
#  "Lake Sinai virus 1" = "#289D8F", 
#  "Lake Sinai Virus NE" = "#289D8F", 
#  "Lake Sinai Virus" = "#289D8F", 
  "Unclassified_other_reads" = "grey",
  "Varroa_Reads" = "black"
)

```


plot


```{r}

plot2 <- long_df %>% 
  mutate(
    island = fct_relevel(island, "oahu", "big island", "Kauai")
  ) %>%  
  ggplot(aes(x = code, y = count, fill = read_category)) +
  geom_bar( stat = "identity", position = "stack") +
  scale_fill_manual(values = custom_colours2) +
  coord_flip() +
  facet_grid(rows = vars(island), scales = "free_y", switch = "y", space = "free_y") +
  labs(
    title = "Total virus Reads per Sample by Island",
    y = "Total reads"
  ) +
    theme(
    plot.margin = margin(0.5, 0.5, 0.5, 0.5, unit = "cm"),
    plot.title = element_text(size = 15, face = "bold"),
    strip.text.y = element_text(angle = 270, face = "bold"),
    strip.placement = "outside",
    axis.title.x = element_text(margin = margin(t = 0.5, b = 0.5, unit = "cm")),
    axis.title.y = element_blank(),
    axis.text = element_text(size = 5),
    legend.position = "bottom",
    panel.grid.major.y = element_blank(),
    ) +
  theme_minimal()

plot2

# Save as PDF
#ggsave("reads_breakdown.pdf", plot = plot2, width = 13, height = 9)

```


## make plot showing virus read composition

Now, prepare the data to plot a histogram of virus reads in each sample


```{r}

df_viruses_long <- df_viruses %>%
  filter(Species != "total_virus_reads") %>%  # Remove total row
  pivot_longer(cols = -Species, names_to = "alias", values_to = "Read_Count")  # Reshape


merged_df_extended <- merged_df %>%
  left_join(df_viruses_long, by = "alias")

merged_df_extended$Read_Count <- as.numeric(as.character(merged_df_extended$Read_Count))

# for some reason each sample has a total here, I need to remove it

merged_df_extended <- merged_df_extended %>%
  filter(Species != "Total")

```


```{r}

# for now I just want to colour the known bee viruses, the odd read of other things isn't what I'm interested in now.

custom_colours3 <- c(
  "Iflavirus aladeformis" = "#d62828",
  "Varroa destructor virus 1" = "#064789",
  "Iflavirus sacbroodi" = "#EDAE49",
  "Apis mellifera filamentous virus" = "#ECA0FF",
  "Lake Sinai virus 1" = "#289D8F", 
  "Lake Sinai virus 2" = "#289D8F", 
  "Lake Sinai Virus NE" = "#289D8F", 
  "Lake Sinai Virus SA1" = "#289D8F", 
  "Lake Sinai Virus SA2" = "#289D8F",
  "Lake Sinai virus TO" = "#289D8F", 
  "Triatovirus nigereginacellulae" = "black"
)

```


Original way, although this contains the phages too

```{r}

 
plot3 <- merged_df_extended %>% 
  mutate(
    island = fct_relevel(island, "oahu", "big island", "Kauai")
  ) %>%  
  ggplot(aes(x = code, y = Read_Count, fill = Species)) +
  geom_bar( stat = "identity", position = "stack") +
  scale_fill_manual(values = custom_colours3) +
  coord_flip() +
  facet_grid(rows = vars(island), scales = "free_y", switch = "y", space = "free_y") +
  labs(
    title = "Total virus Reads per Sample by Island",
    y = "Total reads"
  ) +
    theme(
    plot.margin = margin(0.5, 0.5, 0.5, 0.5, unit = "cm"),
    plot.title = element_text(size = 15, face = "bold"),
    strip.text.y = element_text(angle = 270, face = "bold"),
    strip.placement = "outside",
    axis.title.x = element_text(margin = margin(t = 0.5, b = 0.5, unit = "cm")),
    axis.title.y = element_blank(),
    axis.text = element_text(size = 5),
    legend.position = "bottom",
    panel.grid.major.y = element_blank(),
    ) +
  theme_minimal()

plot3

# Save as PDF
#ggsave("reads_breakdown.pdf", plot = plot2, width = 13, height = 9)



```

try a new version, filtering to only contain the bee-associated viruses

```{r}

bee_viruses_df <- merged_df_extended %>%
  filter(Species %in% c("Iflavirus aladeformis",
  "Varroa destructor virus 1",
  "Iflavirus sacbroodi",
  "Apis mellifera filamentous virus",
  "Lake Sinai virus 1", 
  "Lake Sinai Virus NE", 
  "Lake Sinai Virus 2", 
  "Lake Sinai Virus SA1",
  "Lake Sinai Virus SA2",
  "Lake Sinai Virus TO",
  "Triatovirus nigereginacellulae"))

 
plot4 <- bee_viruses_df %>% 
   group_by(code) %>%
  mutate(Proportion = Read_Count / sum(Read_Count)) %>%  # Compute proportion per sample
  ungroup() %>% 
  mutate(
    island = fct_relevel(island, "oahu", "big island", "Kauai")
  ) %>%  
  ggplot(aes(x = code, y = Proportion, fill = Species)) +
  geom_bar( stat = "identity", position = "stack") +
  scale_fill_manual(values = custom_colours3) +
  coord_flip() +
  facet_grid(rows = vars(island), scales = "free_y", switch = "y", space = "free_y") +
  labs(
    title = "realtiev abundance of bee virus Reads per Sample by Island",
    y = "Total reads"
  ) +
    theme(
    plot.margin = margin(0.5, 0.5, 0.5, 0.5, unit = "cm"),
    plot.title = element_text(size = 15, face = "bold"),
    strip.text.y = element_text(angle = 270, face = "bold"),
    strip.placement = "outside",
    axis.title.x = element_text(margin = margin(t = 0.5, b = 0.5, unit = "cm")),
    axis.title.y = element_blank(),
    axis.text = element_text(size = 5),
    legend.position = "bottom",
    panel.grid.major.y = element_blank(),
    ) +
  theme_minimal()

plot4

# Save as PDF
#ggsave("relative_abundance_bee_viruses.pdf", plot = plot4, width = 13, height = 9)



```


how about as pie charts



```{r}
# Compute relative abundance per island, ensuring it sums to 1
island_avg_df <- bee_viruses_df %>%
  group_by(island, Species) %>%
  summarise(total_reads = sum(Read_Count), .groups = "drop") %>% 
  group_by(island) %>%
  mutate(avg_proportion = total_reads / sum(total_reads))  # Normalize within each island

# Create the faceted pie chart with full circles
pie_chart <- ggplot(island_avg_df, aes(x = "", y = avg_proportion, fill = Species)) +
  geom_bar(stat = "identity", width = 1) +  # Creates the bar segments
  coord_polar(theta = "y") +  # Converts bars into pie charts
  facet_wrap(~island) +  # One pie chart per island
  scale_fill_manual(values = custom_colours3) +  # Use custom colors
  labs(
    title = "Average Relative Abundance of Bee Viruses per Island",
    x = NULL, y = NULL
  ) +
  theme_minimal() +
  theme(
    axis.text = element_blank(),  # Remove axis text
    axis.ticks = element_blank(),  # Remove axis ticks
    panel.grid = element_blank(),  # Remove background grid
    legend.position = "bottom"
  )

pie_chart

#ggsave("bee_virus_pies_all5runs.pdf", plot = pie_chart, width = 7, height = 4)

```



```{r}


```



```{r}


```



```{r}


```

